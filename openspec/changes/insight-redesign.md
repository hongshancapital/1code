# Insight 功能重新设计方案

## 一、设计目标

将 Insight 从"冰冷的统计报告"转变为"温暖的 AI 同事/导师"，让用户感受到：
- **惊喜**：主动推送有趣的洞察
- **陪伴**：像朋友一样关心你的工作
- **成长**：具体的鼓励和建议
- **信任**：真诚地了解你在做什么

---

## 二、核心改动

### 1. 内容风格转变

| 之前 | 之后 |
|------|------|
| 冰冷的 token 统计 | 总结你今天做了什么 |
| 费用报告 | 发现你做得好的地方 |
| 使用模式分析 | 温和地提供建议 |
| 正式的"报告"结构 | 像朋友聊天的语气 |

### 2. 展示形式改变

| 之前 | 之后 |
|------|------|
| 折叠式，需点击展开 | 摘要直接显示，主动推送 |
| 单一 Markdown | 摘要 + 详细报告弹窗 |
| 密集的统计数字 | 温暖的 1-2 句话 |
| 复杂的进度显示 | 简单一行"正在回顾..." |

---

## 三、数据库改动

### 新增字段

```sql
-- drizzle/0013_insight_redesign.sql

ALTER TABLE `insights` ADD COLUMN `summary` text;
ALTER TABLE `insights` ADD COLUMN `report_html` text;
```

| 字段 | 类型 | 说明 |
|------|------|------|
| `summary` | text | 1-2句温暖的摘要，直接显示在卡片上 |
| `report_html` | text | HTML 格式的详细报告，弹窗展示 |

保留 `report_markdown` 用于兼容旧数据。

---

## 四、Agent Prompt 重写

### 系统 Prompt

```
你是用户的 AI 编程搭档，像一个贴心的同事或导师一样陪伴用户工作。

你的语气应该：
- 温暖、亲切、像朋友聊天
- 真诚地关心用户的工作
- 用第二人称"你"来称呼用户
- 适当使用表情符号增加亲和力

你可以读取当前工作目录下的文件：
- stats.json: 使用统计
- index.json: 项目和聊天概览
- chats/*.json: 详细的聊天记录

你的报告应该聚焦于：
1. 总结工作内容：今天你主要在做什么功能/解决什么问题
2. 真诚的鼓励：发现做得好的地方，给予具体的肯定
3. 贴心的观察：如果注意到困难，温和地提供建议
4. 陪伴感：让用户感受到有人在关注他的努力

不要：
- 列出冰冷的 token 统计或费用数字
- 使用"报告"、"分析"这样的正式词汇
- 像写正式文档一样结构化

请生成两部分内容，用以下格式严格分隔：

===SUMMARY===
（2-4句温暖的话，概括今天的工作亮点。直接显示给用户。
例如："今天你在登录模块上花了不少功夫，看起来进展很顺利！"
或："忙碌的一天！你和我讨论了好几个有挑战的问题，但都一一解决了 💪"）

===DETAIL===
（详细的报告内容，使用 HTML 格式，有交互感，温暖且专业的。包含：
- 今天做了什么（基于聊天记录总结实际工作内容）
- 做得好的地方（具体的肯定）
- 温和的建议（如果有的话）
- 一句收尾的话）
```

### 输出示例

**摘要**（直接显示在卡片）:
> 今天你在用户认证模块上花了不少功夫，JWT 的实现看起来很规范！💪

**详细报告**（弹窗展示）:
> ### 今天的工作
>
> 你主要在处理用户认证相关的功能，和我讨论了 JWT token 的存储策略和刷新机制。看得出来你对安全性考虑得很周全，选择了 httpOnly cookie 而不是 localStorage，这是个很好的选择！
>
> ### 做得很棒的地方
>
> - token 刷新逻辑考虑得很完整，处理了边界情况
> - 代码结构清晰，把认证逻辑封装成了独立的 hook
> - 记得处理了 token 过期的用户体验
>
> ### 小建议
>
> 我注意到你在处理并发请求时有些纠结。如果多个请求同时发现 token 过期，可能会触发多次刷新。可以考虑用一个 Promise 队列来解决这个问题，下次有空我们可以一起看看。
>
> ---
>
> 辛苦了！明天继续加油 ✨

---

## 五、前端组件改动

### InsightCard 重构

**之前**:
```
┌─────────────────────────────────────┐
│ 📈 昨日活动  654,473 tokens         │
│ ┌─────────────────────────────────┐ │
│ │ [活动柱状图]                     │ │
│ └─────────────────────────────────┘ │
│ 654.5K Tokens | 121 API 调用 | ~$96 │
│                        [✨ 收起 ↑] │
│ ┌─────────────────────────────────┐ │
│ │ 🌟 亮点                          │ │
│ │ 昨天是你高产的一天！在"1code"... │ │
│ │ 📊 使用模式                      │ │
│ │ ...（大段文字）                  │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**之后**:
```
┌─────────────────────────────────────┐
│ ✨ 工作回顾              日报 02-03 │
├─────────────────────────────────────┤
│                                     │
│ 今天你在用户认证模块上花了不少功夫，│
│ JWT 的实现看起来很规范！💪          │
│                                     │
│                    [查看完整回顾 →] │
└─────────────────────────────────────┘
```

### 生成中状态简化

**之前**: 显示详细步骤、工具调用、字符计数
**之后**: 只显示一行 "正在回顾你的工作..."

### 新增详情弹窗

```
┌─────────────────────────────────────────┐
│ ✨ 2026-02-03 日报                   ✕ │
├─────────────────────────────────────────┤
│ ┌─────────────────────────────────────┐ │
│ │ 今天你在用户认证模块上花了不少     │ │
│ │ 功夫，JWT 的实现看起来很规范！💪   │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ### 今天的工作                          │
│                                         │
│ 你主要在处理用户认证相关的功能...       │
│                                         │
│ ### 做得很棒的地方                      │
│                                         │
│ - token 刷新逻辑考虑得很完整            │
│ - 代码结构清晰                          │
│ ...                                     │
└─────────────────────────────────────────┘
```

---

## 六、文件清单

| 操作 | 文件路径 | 说明 |
|------|----------|------|
| 新增 | `drizzle/0013_insight_redesign.sql` | 数据库迁移 |
| 修改 | `src/main/lib/db/schema/index.ts` | 添加 summary, reportHtml 字段 |
| 修改 | `src/main/lib/insights/types.ts` | 更新类型定义 |
| 修改 | `src/main/lib/insights/generator.ts` | 重写 prompt，解析双段输出 |
| 修改 | `src/main/lib/trpc/routers/insights.ts` | 返回新字段，保存逻辑 |
| 重写 | `src/renderer/features/home/insight-card.tsx` | 主动展示摘要，简化进度 |
| 新增 | `src/renderer/components/dialogs/insight-detail-dialog.tsx` | 详情弹窗 |
| 修改 | `src/renderer/lib/i18n/locales/zh/home.json` | 中文翻译 |
| 修改 | `src/renderer/lib/i18n/locales/en/home.json` | 英文翻译 |

---

## 七、实现步骤

### 阶段 1: 数据层改动 (15min)
1. 创建数据库迁移文件
2. 更新 schema 定义
3. 更新类型定义

### 阶段 2: Agent 改动 (20min)
1. 重写系统 prompt（温暖风格）
2. 修改用户 prompt 模板
3. 添加输出解析函数（分离 summary 和 detail）
4. 更新数据库保存逻辑

### 阶段 3: 前端改动 (40min)
1. 重构 InsightCard
   - 移除活动图表（或移到别处）
   - 主动显示摘要
   - 简化进度显示
2. 创建详情弹窗组件
3. 更新 i18n

### 阶段 4: 测试 (15min)
1. 测试新旧数据兼容
2. 测试弹窗交互
3. 验证内容风格

---

## 八、兼容性考虑

1. **旧数据兼容**: 如果 `summary` 为空，从 `reportMarkdown` 提取第一段作为摘要
2. **渐进式**: 保留 `reportMarkdown` 字段，不删除
3. **回退逻辑**: 如果 Agent 输出格式不对，整体作为 detail 处理

---

## 九、i18n 更新

```json
// zh/home.json
{
  "insights": {
    "title": "工作回顾",
    "analyzing": "正在回顾你的工作...",
    "viewDetail": "查看完整回顾",
    "dailyReport": "{{date}} 日报",
    "weeklyReport": "{{date}} 周报"
  }
}

// en/home.json
{
  "insights": {
    "title": "Work Recap",
    "analyzing": "Reviewing your work...",
    "viewDetail": "See full recap",
    "dailyReport": "Recap for {{date}}",
    "weeklyReport": "Weekly Recap ({{date}})"
  }
}
```

---

## 十、后续优化（可选）

1. **主动通知**: 报告生成完成后，显示一个 toast 提醒用户
2. **个性化**: 根据用户使用习惯调整语气
3. **历史对比**: "这周比上周多完成了 3 个功能！"
4. **目标追踪**: 用户可以设定目标，Insight 跟踪进度
