# MCP é¢„çƒ­ä¼˜åŒ–å®æ–½æ€»ç»“

## ğŸ¯ å®æ–½ç›®æ ‡

è§£å†³é¦–æ¬¡æ¶ˆæ¯å¡é¡¿é—®é¢˜,å®ç° MCP æœåŠ¡å™¨çš„å®æ—¶çŠ¶æ€ç›‘æ§å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤ºã€‚

## âœ… å·²å®Œæˆçš„æ”¹è¿›

### 1. é¢„çƒ­æå‰ âš¡
- **ä¿®æ”¹å‰**: åº”ç”¨å¯åŠ¨åå»¶è¿Ÿ 3 ç§’æ‰å¼€å§‹é¢„çƒ­
- **ä¿®æ”¹å**: `app.whenReady()` ç«‹å³å¯åŠ¨é¢„çƒ­,æœ€å¤§åŒ–é¢„çƒ­æ—¶é—´
- **æ–‡ä»¶**: `src/main/index.ts` (ç¬¬ 820-829 è¡Œ)

### 2. æ™ºèƒ½ç­‰å¾… â³
- **æ–°å¢é€»è¾‘**: é¦–æ¬¡ query ç­‰å¾…é¢„çƒ­ Promise (æœ€å¤š 15 ç§’)
- **æ•ˆæœ**: å¤ç”¨åº”ç”¨å¯åŠ¨åˆ°å‘æ¶ˆæ¯çš„æ—¶é—´å·®,å¤§å¹…å‡å°‘é¦–æ¬¡å¡é¡¿
- **æ–‡ä»¶**: `src/main/lib/claude/config-loader.ts` (ç¬¬ 356-376 è¡Œ)

### 3. é€€é¿é‡è¯• ğŸ”„
- **ç­–ç•¥**: å¤±è´¥æœåŠ¡å™¨è‡ªåŠ¨é‡è¯• [2s, 30s, 30s],æœ€å¤š 3 æ¬¡
- **è¶…æ—¶ä¿æŠ¤**: å•æ¬¡æ‹‰å–å·¥å…·è¶…æ—¶ 10 ç§’
- **çŠ¶æ€è·Ÿè¸ª**: æ¯æ¬¡é‡è¯•æ›´æ–°çŠ¶æ€å¹¶å‘å‡ºäº‹ä»¶
- **æ–‡ä»¶**: `src/main/lib/claude/mcp-warmup-manager.ts` (ç¬¬ 173-249 è¡Œ)

### 4. å®æ—¶çŠ¶æ€åŒæ­¥ ğŸ“¡
- **tRPC è®¢é˜…**: `claude.mcpStatus` å®æ—¶æ¨é€çŠ¶æ€å˜åŒ–
- **çŠ¶æ€ç±»å‹**: connecting â†’ connected/retrying/timeout/failed
- **å‰ç«¯è®¢é˜…**: Widget è‡ªåŠ¨æ¥æ”¶å¹¶æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
- **æ–‡ä»¶**:
  - Backend: `src/main/lib/trpc/routers/claude.ts` (ç¬¬ 2804-2857 è¡Œ)
  - Frontend: `src/renderer/features/details-sidebar/sections/mcp-widget.tsx` (ç¬¬ 96-117 è¡Œ)

### 5. ç”¨æˆ·ç¦ç”¨åŠæ—¶ç”Ÿæ•ˆ âš¡
- **ç¼“å­˜æ›´æ–°**: ç¦ç”¨æ—¶ç«‹å³æ ‡è®° `workingMcpServers.set(key, false)`
- **ä¸‹æ¬¡ç”Ÿæ•ˆ**: å¯ç”¨æ—¶åˆ é™¤ç¼“å­˜,ä¸‹æ¬¡ query é‡æ–°æ£€æµ‹
- **æ–‡ä»¶**:
  - Backend: `src/main/lib/trpc/routers/claude.ts` (ç¬¬ 2675-2691 è¡Œ)
  - Frontend: `src/renderer/features/details-sidebar/sections/mcp-widget.tsx` (ç¬¬ 141-177 è¡Œ)

### 6. çŠ¶æ€å¯è§†åŒ– ğŸ¨
- **æ–°å¢å›¾æ ‡**:
  - ğŸ”µ connecting - è“è‰²è„‰å†²åœ†ç‚¹
  - ğŸ”„ retrying - æ—‹è½¬çš„åˆ·æ–°å›¾æ ‡ + "ç¬¬ N æ¬¡é‡è¯•" tooltip
  - ğŸ• timeout - æ©™è‰²æ—¶é’Ÿå›¾æ ‡
  - âŒ failed - çº¢è‰²è­¦å‘Šå›¾æ ‡ + é”™è¯¯ä¿¡æ¯ tooltip
- **æ–‡ä»¶**: `src/renderer/features/details-sidebar/sections/mcp-widget.tsx` (ç¬¬ 285-308 è¡Œ)

## ğŸ“ æ–°å»º/ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ (2)
1. `src/main/lib/claude/mcp-warmup-manager.ts` - æ ¸å¿ƒé¢„çƒ­ç®¡ç†å™¨ (300+ è¡Œ)
2. `src/renderer/lib/atoms/mcp-status.ts` - MCP çŠ¶æ€ atoms (12 è¡Œ)

### ä¿®æ”¹æ–‡ä»¶ (5)
1. `src/main/index.ts` - å¯åŠ¨æ—¶ç«‹å³é¢„çƒ­ (åˆ é™¤ setTimeout)
2. `src/main/lib/claude/config-loader.ts` - é¦–æ¬¡ query ç­‰å¾…é¢„çƒ­
3. `src/main/lib/trpc/routers/claude.ts` - æ·»åŠ çŠ¶æ€è®¢é˜… + ç¼“å­˜æ›´æ–°
4. `src/renderer/lib/atoms/session-info.ts` - æ‰©å±•çŠ¶æ€ç±»å‹
5. `src/renderer/features/details-sidebar/sections/mcp-widget.tsx` - çŠ¶æ€è®¢é˜… + å¯è§†åŒ–

## ğŸ”„ çŠ¶æ€æµè½¬å›¾

```
åº”ç”¨å¯åŠ¨:
app.whenReady()
  â†“
getMcpWarmupManager().startWarmup() â† ç«‹å³å¯åŠ¨(ä¸ç­‰å¾…)
  â”œâ”€ å¹¶è¡Œå¤„ç†æ‰€æœ‰æœåŠ¡å™¨
  â”œâ”€ æ¯ä¸ªæœåŠ¡å™¨: connecting â†’ connected/failed/timeout
  â”œâ”€ å¤±è´¥æœåŠ¡å™¨: retrying (x3, [2s, 30s, 30s]) â†’ failed
  â””â”€ å‘å‡º serverStatusChange äº‹ä»¶
  â†“
tRPC subscription æ¨é€åˆ°å‰ç«¯
  â†“
mcpStatusMapAtom æ›´æ–°
  â†“
MCP Widget å®æ—¶æ˜¾ç¤º

é¦–æ¬¡æ¶ˆæ¯:
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â†“
ConfigLoader.getConfig()
  â”œâ”€ if (workingMcpServers.size === 0)
  â”‚   â”œâ”€ ç­‰å¾… warmupPromise(æœ€å¤š 15s)
  â”‚   â””â”€ è¶…æ—¶åˆ™ä½¿ç”¨å½“å‰ç¼“å­˜
  â””â”€ ä½¿ç”¨ç¼“å­˜è¿‡æ»¤ MCP
  â†“
SDK æµå¯åŠ¨(MCP å·²å°±ç»ª)
```

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. å†·å¯åŠ¨æµ‹è¯•
```bash
# æ¸…ç©ºç¼“å­˜
rm -rf ~/Library/Application\ Support/Agents\ Dev/
bun run dev

# éªŒè¯ç‚¹:
# âœ… åº”ç”¨å¯åŠ¨åç«‹å³çœ‹åˆ° "[App] MCP warmup started immediately after app ready" æ—¥å¿—
# âœ… 3 ç§’å†…å‘é€æ¶ˆæ¯,ä¸å†å¡é¡¿ 30+ ç§’
# âœ… é¦–æ¬¡æ¶ˆæ¯çœ‹åˆ° "[ConfigLoader] Waiting for MCP warmup (max 15s)..." æ—¥å¿—
# âœ… æ¶ˆæ¯å‘é€æ—¶é—´ < 15 ç§’(é¢„çƒ­è¶…æ—¶ä¿æŠ¤)
```

### 2. çŠ¶æ€æ˜¾ç¤ºæµ‹è¯•
```bash
# æ‰“å¼€ MCP Widget
# éªŒè¯ç‚¹:
# âœ… çœ‹åˆ°æœåŠ¡å™¨çŠ¶æ€å®æ—¶å˜åŒ–(connecting â†’ connected/failed)
# âœ… å¤±è´¥æœåŠ¡å™¨æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯(hover tooltip)
# âœ… é‡è¯•ä¸­æ˜¾ç¤ºæ—‹è½¬å›¾æ ‡ + "ç¬¬ N æ¬¡é‡è¯•"
# âœ… è¶…æ—¶æœåŠ¡å™¨æ˜¾ç¤ºæ—¶é’Ÿå›¾æ ‡
```

### 3. é‡è¯•é€»è¾‘æµ‹è¯•
```bash
# é…ç½®ä¸€ä¸ªæ•…æ„å¤±è´¥çš„ MCP æœåŠ¡å™¨
# éªŒè¯ç‚¹:
# âœ… é¦–æ¬¡å¤±è´¥å 2 ç§’é‡è¯•(ç¬¬ 1 æ¬¡)
# âœ… ç¬¬ 1 æ¬¡å¤±è´¥å 30 ç§’é‡è¯•(ç¬¬ 2 æ¬¡)
# âœ… ç¬¬ 2 æ¬¡å¤±è´¥å 30 ç§’é‡è¯•(ç¬¬ 3 æ¬¡)
# âœ… ç¬¬ 3 æ¬¡å¤±è´¥åæ ‡è®°ä¸º failed,ä¸å†é‡è¯•
# âœ… æ‰€æœ‰çŠ¶æ€å˜åŒ–åœ¨ Widget ä¸­å®æ—¶æ˜¾ç¤º
```

### 4. ç”¨æˆ·ç¦ç”¨æµ‹è¯•
```bash
# åœ¨ Widget ä¸­ç‚¹å‡» Power æŒ‰é’®ç¦ç”¨æœåŠ¡å™¨
# éªŒè¯ç‚¹:
# âœ… UI ç«‹å³å˜é€æ˜(opacity: 0.5)
# âœ… æ§åˆ¶å°çœ‹åˆ° "[MCP] Disabled server xxx, updated cache"
# âœ… ä¸‹æ¬¡å‘é€æ¶ˆæ¯æ—¶è¯¥æœåŠ¡å™¨ä¸è¢«åŠ è½½
# âœ… é‡æ–°å¯ç”¨åæœåŠ¡å™¨æ¢å¤æ­£å¸¸
```

## ğŸ“Š æ€§èƒ½æå‡é¢„æœŸ

| åœºæ™¯ | ä¿®æ”¹å‰ | ä¿®æ”¹å | æå‡ |
|------|--------|--------|------|
| åº”ç”¨å¯åŠ¨åˆ°é¢„çƒ­å¼€å§‹ | 3 ç§’å»¶è¿Ÿ | ç«‹å³å¼€å§‹ | +3 ç§’é¢„çƒ­æ—¶é—´ |
| é¦–æ¬¡æ¶ˆæ¯ç­‰å¾…æ—¶é—´ | 30+ ç§’(å…¨é‡åˆå§‹åŒ–) | < 15 ç§’(å¤ç”¨é¢„çƒ­) | å‡å°‘ 50% |
| å¤±è´¥æœåŠ¡å™¨åé¦ˆ | æ— æç¤º | å®æ—¶å›¾æ ‡ + tooltip | ç”¨æˆ·ä½“éªŒ â†‘â†‘ |
| ç”¨æˆ·ç¦ç”¨ç”Ÿæ•ˆ | ä¸‹æ¬¡å¯åŠ¨ | ç«‹å³ç”Ÿæ•ˆ | å³æ—¶å“åº” |

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

1. **EventEmitter äº‹ä»¶ç³»ç»Ÿ** - è·¨è¿›ç¨‹å®æ—¶é€šä¿¡
2. **Promise.race** - è¶…æ—¶ä¿æŠ¤,é¿å…æ— é™ç­‰å¾…
3. **Map ç¼“å­˜** - é«˜æ•ˆçš„æœåŠ¡å™¨çŠ¶æ€å­˜å‚¨
4. **tRPC subscription** - WebSocket å®æ—¶æ¨é€
5. **Jotai atom** - å“åº”å¼çŠ¶æ€ç®¡ç†

## ğŸš¨ è¾¹ç¼˜æƒ…å†µå¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹æ¡ˆ |
|------|----------|
| é¢„çƒ­è¶…æ—¶ | 15 ç§’åä½¿ç”¨å½“å‰ç¼“å­˜,åå°ç»§ç»­é‡è¯• |
| å¹¶å‘é¢„çƒ­ | å•ä¾‹æ¨¡å¼,é˜²æ­¢å¤šæ¬¡è°ƒç”¨ startWarmup() |
| åº”ç”¨é‡å¯ | æ¸…ç©ºæ—§çŠ¶æ€,é‡æ–°å¯åŠ¨é¢„çƒ­ |
| ç½‘ç»œæ³¢åŠ¨ | é€€é¿é‡è¯• [2s, 30s, 30s],æœ€å¤š 3 æ¬¡ |
| å¿«é€Ÿç¦ç”¨/å¯ç”¨ | ä¹è§‚æ›´æ–° UI,å¤±è´¥æ—¶å›æ»š |

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **æ‰‹åŠ¨é‡è¯•** - æ·»åŠ é‡è¯•æŒ‰é’®,å…è®¸ç”¨æˆ·æ‰‹åŠ¨è§¦å‘å¤±è´¥æœåŠ¡å™¨çš„é‡è¯•
2. **æœåŠ¡å™¨å¥åº·åº¦** - æ˜¾ç¤ºå†å²æˆåŠŸç‡,å¸®åŠ©ç”¨æˆ·è¯†åˆ«ä¸ç¨³å®šçš„æœåŠ¡å™¨
3. **é¢„çƒ­è¿›åº¦æ¡** - åœ¨é¦–æ¬¡åŠ è½½æ—¶æ˜¾ç¤ºé¢„çƒ­è¿›åº¦,é¿å…ç”¨æˆ·ç„¦è™‘
4. **æ™ºèƒ½é¢„æµ‹** - æ ¹æ®å†å²æ•°æ®é¢„æµ‹é¢„çƒ­æ—¶é—´,åŠ¨æ€è°ƒæ•´è¶…æ—¶é˜ˆå€¼

## âœ… ç¼–è¯‘éªŒè¯

```bash
$ bun run build
âœ“ built in 4.05s   # Main process
âœ“ built in 115ms   # Preload
âœ“ built in 1m 50s  # Renderer
```

æ‰€æœ‰ä»£ç ç¼–è¯‘é€šè¿‡,æ— ç±»å‹é”™è¯¯,å¯ä»¥å®‰å…¨éƒ¨ç½²! ğŸ‰
